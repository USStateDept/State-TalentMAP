import { shallow } from 'enzyme';
import React from 'react';
import ReactDOM from 'react-dom';
import TestUtils from 'react-dom/test-utils';
import { MemoryRouter } from 'react-router-dom';
import createRouterContext from 'react-router-test-context';
import { createStore, applyMiddleware } from 'redux';
import thunk from 'redux-thunk';
import createHistory from 'history/createBrowserHistory';
import { routerMiddleware } from 'react-router-redux';
import rootReducer from '../../reducers';
import Filters from './Filters';

const history = createHistory();

const middleware = routerMiddleware(history);

function configureStore(initialState) {
  return createStore(
        rootReducer,
        initialState,
        applyMiddleware(thunk, middleware),
    );
}
const store = configureStore();

const context = createRouterContext();

let wrapper = null;

describe('FiltersComponent', () => {
  const items = [
    {
      item: {
        title: 'Skill code',
        sort: 100,
        description: 'skill',
        endpoint: 'position/skills',
        selectionRef: 'skill__code__in',
        text: 'Choose skill codes',
      },
      data: [
        { id: 2, code: '0010', description: 'EXECUTIVE (PAS)' },
        { id: 3, code: '0020', description: 'EXECUTIVE (CAREER)' },
      ],
    },
    {
      item: {
        title: 'Language',
        sort: 200,
        description: 'language',
        endpoint: 'language',
        selectionRef: 'languages__language__code__in',
        text: 'Choose languages',
      },
      data: [
        { id: 3, code: 'AB', long_description: 'Albanian', short_description: 'Albanian', effective_date: '1984-05-04' },
        { id: 4, code: 'AC', long_description: 'Amharic', short_description: 'Amharic', effective_date: '1984-05-04' },
      ],
    },
    {
      item: {
        title: 'Grade',
        sort: 300,
        description: 'grade',
        endpoint: 'position/grades',
        selectionRef: 'grade__code__in',
        text: 'Choose grades',
      },
      data: [
        { id: 2, code: '00' },
        { id: 3, code: '01' },
      ],
    },
    {
      item: {
        title: 'Tour of Duty',
        sort: 400,
        description: 'tod',
        endpoint: 'organization/tod',
        selectionRef: 'post__tour_of_duty__code__in',
        text: 'Choose tour of duty length',
        choices: [
        ],
      },
      data: [
        { id: 2, code: '00', long_description: '13YRR' },
        { id: 3, code: '01', long_description: '23YRR' },
      ],
    },
    {
      item: {
        title: 'Region',
        sort: 500,
        description: 'region',
        endpoint: 'organization',
        selectionRef: 'organization__code__in',
        text: 'Choose region',
        choices: [
        ],
      },
      data: [
        { id: 2, code: '00', long_description: 'Operations Center' },
        { id: 3, code: '01', long_description: 'Los Angeles' },
      ],
    },
    {
      item: {
        title: 'COLA',
        sort: 600,
        bool: true, // use bool: true to share a common HTML template
        description: 'COLA',
        selectionRef: 'post__cost_of_living_adjustment__gt',
        text: 'Include only positions with COLA',
        choices: [
        ],
      },
      data: [
        { code: '0', short_description: 'Yes' }, // use a code of 0 to specify we want to return results where COLA > 0
      ],
    },
    {
      item: {
        title: 'Post Differential',
        sort: 700,
        bool: true,
        description: 'postDiff',
        selectionRef: 'post__differential_rate__gt',
        text: 'Include only positions with a post differential',
        choices: [
        ],
      },
      data: [
        { code: '0', short_description: 'Yes' },
      ],
    },
    {
      item: {
        title: 'Danger pay',
        sort: 800,
        bool: true,
        description: 'dangerPay',
        selectionRef: 'post__danger_pay__gt',
        text: 'Include only positions with danger pay',
        choices: [
        ],
      },
      data: [
        { code: '0', short_description: 'Yes' },
      ],
    },
  ];

  it('renders without crashing', () => {
    const div = document.createElement('div');
    ReactDOM.render(<MemoryRouter>
      <Filters items={items} store={store} /></MemoryRouter>, div);
  });

  it('is defined', (done) => {
    const home = TestUtils.renderIntoDocument(<MemoryRouter>
      <Filters store={store} items={items} location={{}} />
    </MemoryRouter>, { context });
    const f = () => {
      setTimeout(() => {
        expect(home).toBeDefined();
        done();
      }, 0);
    };
    f();
  });

  it('can create a query string', (done) => {
    wrapper = shallow(<Filters items={items} />, { context });
    const f = () => {
      setTimeout(() => {
        wrapper.instance().changeText({ target: { value: 'info Tech' } });
        expect(wrapper.instance().state.qString).toBe('q=info%20Tech');
        done();
      }, 0);
    };
    f();
  });

  it('can call the createQueryString function to create multi-parameter query strings', (done) => {
    wrapper = shallow(<Filters items={items} />, { context });
    const f = () => {
      setTimeout(() => {
        wrapper.instance().changeText({ target: { value: 'info Tech' } });
        wrapper.find('#S0010').simulate('change', (0, { target: { checked: true, value: '0010' } }));
        wrapper.find('#S0020').simulate('change', (0, { target: { checked: true, value: '0020' } }));
        wrapper.find('#TOD00').simulate('change', (0, { target: { checked: true, value: '2' } }));
        wrapper.find('#R00').simulate('change', (0, { target: { checked: true, value: '2' } }));
        expect(wrapper.instance().state.qString).toBe('organization__code__in=2&post__tour_of_duty__code__in=2&q=info%20Tech&skill__code__in=0010%2C0020');
        done();
      }, 0);
    };
    f();
  });

  it('can check a checkbox', (done) => {
    wrapper = shallow(<Filters items={items} />, { context });
    const f = () => {
      setTimeout(() => {
        wrapper.find('#S0010').simulate('change', (0, { target: { checked: true, value: '0010' } }));
        wrapper.find('#TOD00').simulate('change', (0, { target: { checked: true, value: '2' } }));
        wrapper.find('#R00').simulate('change', (0, { target: { checked: true, value: '2' } }));
        // test one of the boolean filters
        wrapper.find('#COLA').simulate('change', (0, { target: { checked: true, value: '0' } }));
        done();
      }, 0);
    };
    f();
  });

  it('can check and then uncheck a checkbox', (done) => {
    wrapper = shallow(<Filters items={items} />, { context });
    const f = () => {
      setTimeout(() => {
        wrapper.find('#S0010').simulate('change', (0, { target: { checked: true, value: '0010' } }));
        expect(wrapper.instance().state.selection.skill__code__in.length).toBe(1);
        wrapper.find('#S0010').simulate('change', (0, { target: { checked: false, value: '0010' } }));
        wrapper.find('#LAB').simulate('change', (1, { target: { checked: true, value: 'AB' } }));
        expect(wrapper.instance().state.selection.languages__language__code__in.length).toBe(1);
        wrapper.find('#LAB').simulate('change', (1, { target: { checked: false, value: 'AB' } }));
        wrapper.find('#G00').simulate('change', (2, { target: { checked: true, value: '00' } }));
        expect(wrapper.instance().state.selection.grade__code__in.length).toBe(1);
        wrapper.find('#G00').simulate('change', (2, { target: { checked: false, value: '00' } }));
        expect(wrapper.instance().state.selection.skill__code__in.length).toBe(0);
        expect(wrapper.instance().state.selection.languages__language__code__in.length).toBe(0);
        expect(wrapper.instance().state.selection.grade__code__in.length).toBe(0);
        done();
      }, 0);
    };
    f();
  });

  it('should disable search if less than two filters are selected', (done) => {
    wrapper = shallow(<Filters items={items} />, { context });
    const f = () => {
      setTimeout(() => {
        // no filters are initially set, so should return true
        expect(wrapper.instance().shouldDisableSearch()).toBe(true);
        // enable search filter
        wrapper.instance().changeText({ target: { value: 'test' } });
        // select a checkbox filter
        wrapper.find('#S0010').simulate('change', (0, { target: { checked: true, value: '0010' } }));
        expect(wrapper.instance().shouldDisableSearch()).toBe(false);
        // remove the original search filter
        wrapper.instance().changeText({ target: { value: '' } });
        // one filter is selected, should return false
        expect(wrapper.instance().shouldDisableSearch()).toBe(true);
        done();
      }, 0);
    };
    f();
  });

  it('should enable search if two filters are selected, excluding search text', (done) => {
    wrapper = shallow(<Filters items={items} />, { context });
    const f = () => {
      setTimeout(() => {
        // no filters are initially set, so should return true
        expect(wrapper.instance().shouldDisableSearch()).toBe(true);
        // select a language filter
        wrapper.find('#LAB').simulate('change', (1, { target: { checked: true, value: 'AB' } }));
        // select a skill filter
        wrapper.find('#S0010').simulate('change', (0, { target: { checked: true, value: '0010' } }));
        expect(wrapper.instance().shouldDisableSearch()).toBe(false);
        done();
      }, 0);
    };
    f();
  });

  it('should be able to enable language proficiency filters', (done) => {
    wrapper = shallow(<Filters items={items} />, { context });
    const f = () => {
      setTimeout(() => {
        // change English written to 1
        wrapper.find('#Albanian-written-1').simulate('click', ('Albanian-written', '1', 1));
        // change English spoken to 1
        wrapper.find('#Albanian-spoken-1').simulate('click', ('Albanian-written', '1', 1));
        // English written should be 1
        expect(wrapper.instance().state.proficiency['Albanian-written']).toBe('1');
        // English spoken should be 1
        expect(wrapper.instance().state.proficiency['Albanian-spoken']).toBe('1');
        done();
      }, 0);
    };
    f();
  });

  it('should be able to submit a search', (done) => {
    wrapper = shallow(<Filters items={items} />, { context });
    const f = () => {
      setTimeout(() => {
        wrapper.instance().changeText({ target: { value: 'test' } });
        wrapper.instance().submitSearch({ preventDefault: () => {} });
        done();
      }, 0);
    };
    f();
  });
});
